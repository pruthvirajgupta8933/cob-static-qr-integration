<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDFC QR API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #qrImage {
            max-width: 300px;
            margin: 20px auto;
            display: block;
        }
        .credentials {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .credentials h3 {
            margin-top: 0;
        }
        .credentials p {
            margin: 5px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß HDFC UPI API Integration Test</h1>
        
        <div class="credentials">
            <h3>Current Configuration (UAT)</h3>
            <p>Merchant ID: HDFC000010380443</p>
            <p>VPA: sabpaisa@hdfcbank</p>
            <p>API URL: https://upitestv2.hdfcbank.com/upi</p>
        </div>

        <div class="test-section">
            <h3>1. Generate Static QR String</h3>
            <button onclick="generateQRString()">Generate UPI String</button>
            <div id="qrStringResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. Generate QR Code Image</h3>
            <button onclick="generateQRCode()">Generate QR Code</button>
            <img id="qrImage" style="display:none;">
            <div id="qrCodeResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Encryption</h3>
            <button onclick="testEncryption()">Test AES128 Encryption</button>
            <div id="encryptionResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Simulate Payment Callback</h3>
            <button onclick="simulateCallback()">Simulate Success Callback</button>
            <button onclick="simulateFailureCallback()">Simulate Failure Callback</button>
            <div id="callbackResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Test API Service (Check Console)</h3>
            <button onclick="testAPIService()">Test Service Integration</button>
            <div id="apiResult" class="result"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        const CONFIG = {
            merchantId: 'HDFC000010380443',
            merchantKey: 'ef880fed3abe10d54102a24e05e41ca2',
            vpa: 'sabpaisa@hdfcbank'
        };

        function generateQRString() {
            const identifier = 'TEST' + Math.floor(Math.random() * 10000);
            const timestamp = Date.now();
            const transactionRef = `STQ${identifier}${timestamp}`;
            
            const upiString = [
                'upi://pay?',
                'ver=01',
                '&mode=01',
                `&tr=${transactionRef}`,
                '&tn=Test%20Payment',
                '&pn=SRS%20Live%20Technologies',
                `&pa=${CONFIG.vpa}`,
                '&mc=5499',
                '&am=100',
                '&cu=INR',
                '&qrMedium=06'
            ].join('');

            document.getElementById('qrStringResult').innerHTML = 
                `<div class="success">‚úÖ QR String Generated Successfully!</div>
                <strong>UPI String:</strong>\n${upiString}\n\n
                <strong>Transaction Reference:</strong> ${transactionRef}\n
                <strong>VPA:</strong> ${CONFIG.vpa}`;
        }

        async function generateQRCode() {
            const identifier = 'QR' + Math.floor(Math.random() * 10000);
            const timestamp = Date.now();
            const transactionRef = `STQ${identifier}${timestamp}`;
            
            const upiString = [
                'upi://pay?',
                'ver=01',
                '&mode=01',
                `&tr=${transactionRef}`,
                '&tn=Test%20Payment',
                '&pn=SRS%20Live%20Technologies',
                `&pa=${CONFIG.vpa}`,
                '&mc=5499',
                '&am=100',
                '&cu=INR',
                '&qrMedium=06'
            ].join('');

            try {
                const canvas = document.createElement('canvas');
                await QRCode.toCanvas(canvas, upiString, {
                    width: 300,
                    margin: 2
                });
                
                const dataUrl = canvas.toDataURL();
                document.getElementById('qrImage').src = dataUrl;
                document.getElementById('qrImage').style.display = 'block';
                
                document.getElementById('qrCodeResult').innerHTML = 
                    `<div class="success">‚úÖ QR Code Generated!</div>
                    Scan this QR code with any UPI app to make a payment of ‚Çπ100`;
            } catch (error) {
                document.getElementById('qrCodeResult').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function testEncryption() {
            const testData = {
                merchantId: CONFIG.merchantId,
                amount: 100,
                transactionRef: 'STQ' + Date.now()
            };

            const plainText = JSON.stringify(testData);
            
            // Encrypt
            const encrypted = CryptoJS.AES.encrypt(plainText, CryptoJS.enc.Utf8.parse(CONFIG.merchantKey), {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.Pkcs7
            }).toString();

            // Decrypt
            const decrypted = CryptoJS.AES.decrypt(encrypted, CryptoJS.enc.Utf8.parse(CONFIG.merchantKey), {
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.Pkcs7
            }).toString(CryptoJS.enc.Utf8);

            const isValid = plainText === decrypted;

            document.getElementById('encryptionResult').innerHTML = 
                `<div class="${isValid ? 'success' : 'error'}">
                ${isValid ? '‚úÖ Encryption/Decryption Working!' : '‚ùå Encryption Failed'}</div>
                <strong>Original:</strong>\n${plainText}\n\n
                <strong>Encrypted:</strong>\n${encrypted.substring(0, 50)}...\n\n
                <strong>Decrypted:</strong>\n${decrypted}`;
        }

        function simulateCallback() {
            const txnId = 'TXN' + Date.now();
            const callbackData = [
                CONFIG.merchantId,
                'SRS Live Technologies',
                'TERM001',
                txnId,
                'RRN' + Date.now(),
                'MERCHTXN001',
                '100.00',
                'SUCCESS',
                'Transaction Successful',
                'customer@paytm',
                'Test Customer',
                '9876543210',
                new Date().toISOString(),
                '100.00',
                new Date().toISOString(),
                'UPI',
                '5499',
                '0',
                '0',
                '100.00',
                'checksum123'
            ].join('|');

            // Trigger custom event (simulating webhook)
            window.dispatchEvent(new CustomEvent('payment-success', {
                detail: {
                    transactionId: txnId,
                    amount: 100,
                    payerName: 'Test Customer',
                    payerVPA: 'customer@paytm',
                    transactionStatus: 'SUCCESS',
                    transactionDateTime: new Date().toISOString()
                }
            }));

            document.getElementById('callbackResult').innerHTML = 
                `<div class="success">‚úÖ Success Callback Simulated!</div>
                <strong>Transaction ID:</strong> ${txnId}\n
                <strong>Amount:</strong> ‚Çπ100\n
                <strong>Status:</strong> SUCCESS\n
                <strong>Raw Callback:</strong>\n${callbackData.substring(0, 100)}...\n\n
                Check the console and UI for payment notification!`;
        }

        function simulateFailureCallback() {
            const txnId = 'TXN' + Date.now();
            
            window.dispatchEvent(new CustomEvent('payment-failed', {
                detail: {
                    transactionId: txnId,
                    statusDescription: 'Insufficient Balance',
                    transactionStatus: 'FAILED'
                }
            }));

            document.getElementById('callbackResult').innerHTML = 
                `<div class="error">‚ùå Failure Callback Simulated!</div>
                <strong>Transaction ID:</strong> ${txnId}\n
                <strong>Status:</strong> FAILED\n
                <strong>Reason:</strong> Insufficient Balance`;
        }

        async function testAPIService() {
            try {
                // Test if services are available
                const hasEncryption = typeof window.encryptionService !== 'undefined';
                const hasHDFCService = typeof window.hdfcApiService !== 'undefined';
                
                // Check Redux store
                const hasRedux = typeof window.__REDUX_DEVTOOLS_EXTENSION__ !== 'undefined';
                
                document.getElementById('apiResult').innerHTML = 
                    `<div class="success">‚úÖ Integration Check Complete!</div>
                    <strong>Services Status:</strong>
                    ‚Ä¢ Encryption Service: ${hasEncryption ? '‚úÖ Available' : '‚ö†Ô∏è Not loaded (check imports)'}
                    ‚Ä¢ HDFC API Service: ${hasHDFCService ? '‚úÖ Available' : '‚ö†Ô∏è Not loaded (check imports)'}
                    ‚Ä¢ Redux DevTools: ${hasRedux ? '‚úÖ Available' : '‚ö†Ô∏è Not installed'}
                    
                    <strong>Next Steps:</strong>
                    1. Open Developer Console (F12)
                    2. Navigate to Static QR in the app
                    3. Try generating a QR code
                    4. Check Network tab for API calls`;
                    
                console.log('=== API Service Test ===');
                console.log('Configuration:', CONFIG);
                console.log('Check the Network tab when generating QR in the app');
                console.log('Look for requests to:', 'https://upitestv2.hdfcbank.com/upi');
            } catch (error) {
                document.getElementById('apiResult').innerHTML = 
                    `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Listen for payment events
        window.addEventListener('payment-success', (event) => {
            console.log('Payment Success Event Received:', event.detail);
            alert('Payment Success Event Triggered! Check console for details.');
        });

        window.addEventListener('payment-failed', (event) => {
            console.log('Payment Failed Event Received:', event.detail);
            alert('Payment Failed Event Triggered! Check console for details.');
        });
    </script>
</body>
</html>